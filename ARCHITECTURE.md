# DataLens AI - Kiáº¿n TrÃºc Há»‡ Thá»‘ng

## Tá»•ng Quan

DataLens AI lÃ  má»™t há»‡ thá»‘ng AI-powered database query assistant, cho phÃ©p ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn. Há»‡ thá»‘ng sá»­ dá»¥ng Google Gemini AI vá»›i Function Calling Ä‘á»ƒ tá»± Ä‘á»™ng sinh vÃ  thá»±c thi SQL queries.

## Kiáº¿n TrÃºc Tá»•ng Thá»ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INTERFACE                        â”‚
â”‚  (React + TypeScript + Redux)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND SERVICES                         â”‚
â”‚  - AI Service Factory                                        â”‚
â”‚  - Database API Service                                      â”‚
â”‚  - Schema Search Service                                     â”‚
â”‚  - Query Execution Service                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND SERVER                            â”‚
â”‚  (Express + TypeScript)                                      â”‚
â”‚  - Database Info Repository                                  â”‚
â”‚  - Schema Info Repository                                    â”‚
â”‚  - Schema Service                                            â”‚
â”‚  - Query Execution Service                                   â”‚
â”‚  - Embedding Service (PostgreSQL + pgvector)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EXTERNAL SERVICES                           â”‚
â”‚  - Google Gemini AI (Smart Agent + Function Calling)        â”‚
â”‚  - Target Databases (MSSQL, PostgreSQL, MySQL)              â”‚
â”‚  - Vector Database (PostgreSQL + pgvector)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ThÃ nh Pháº§n ChÃ­nh

### 1. **Smart AI Agent** (Core Feature)
ğŸ“ `src/services/aiService2.ts`

ÄÃ¢y lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng - má»™t intelligent agent sá»­ dá»¥ng Google Gemini vá»›i Function Calling.

**Kiáº¿n trÃºc Agent:**
```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Smart AI Agent (Gemini 2.5)         â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   System Instruction               â”‚    â”‚
â”‚  â”‚   - Database Schema Context        â”‚    â”‚
â”‚  â”‚   - SQL Guidelines                 â”‚    â”‚
â”‚  â”‚   - Chart Generation Rules         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Function Declarations            â”‚    â”‚
â”‚  â”‚   - execute_sql()                  â”‚    â”‚
â”‚  â”‚     â€¢ sql: string                  â”‚    â”‚
â”‚  â”‚     â€¢ purpose: string              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Iterative Execution Loop         â”‚    â”‚
â”‚  â”‚   1. Parse user question           â”‚    â”‚
â”‚  â”‚   2. Decide: Query or Respond?     â”‚    â”‚
â”‚  â”‚   3. Call execute_sql if needed    â”‚    â”‚
â”‚  â”‚   4. Analyze results               â”‚    â”‚
â”‚  â”‚   5. Generate final answer         â”‚    â”‚
â”‚  â”‚   6. Extract chart data            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Cáº£i tiáº¿n so vá»›i Multi-step Approach:**
- âœ… **ÄÆ¡n giáº£n hÆ¡n**: Má»™t agent thay vÃ¬ nhiá»u bÆ°á»›c phá»©c táº¡p
- âœ… **ThÃ´ng minh hÆ¡n**: AI tá»± quyáº¿t Ä‘á»‹nh khi nÃ o cáº§n query database
- âœ… **Nhanh hÆ¡n**: KhÃ´ng cÃ³ bÆ°á»›c query khÃ´ng cáº§n thiáº¿t
- âœ… **Tá»± nhiÃªn hÆ¡n**: Luá»“ng há»™i thoáº¡i mÆ°á»£t mÃ 
- âœ… **Linh hoáº¡t**: Xá»­ lÃ½ cáº£ data queries vÃ  general chat

### 2. **Schema Management & RAG System**

#### 2.1 Schema Extraction & Cleaning
```typescript
Database â†’ Raw Schema â†’ AI Cleaning â†’ Enriched Schema â†’ Vector Storage
```

**Flow chi tiáº¿t:**
1. **Extract Schema**: Query metadata tá»« database (tables, columns, relationships)
2. **AI Cleaning**: Gemini AI lÃ m sáº¡ch vÃ  lÃ m giÃ u schema
   - Loáº¡i bá» system tables khÃ´ng cáº§n thiáº¿t
   - ThÃªm business descriptions
   - PhÃ¢n loáº¡i theo categories
   - ÄÃ¡nh dáº¥u relevance
3. **Batch Processing**: Xá»­ lÃ½ 50 tables/batch cho schema lá»›n
4. **Vector Storage**: LÆ°u embeddings vÃ o PostgreSQL + pgvector

#### 2.2 Schema Search (RAG)
```typescript
User Question â†’ Embedding â†’ Vector Search â†’ Top 15 Relevant Tables â†’ AI Agent
```

**Æ¯u Ä‘iá»ƒm:**
- Chá»‰ gá»­i relevant schema cho AI (tiáº¿t kiá»‡m tokens)
- Semantic search cho káº¿t quáº£ chÃ­nh xÃ¡c
- Scale tá»‘t vá»›i database lá»›n (hÃ ng trÄƒm tables)

### 3. **Query Flow - End-to-End**

```mermaid
graph TD
    A[User Input Question] --> B{Database Connected?}
    B -->|No| C[Error: Select Database]
    B -->|Yes| D[Search Relevant Tables RAG]
    
    D --> E{Found Schema?}
    E -->|No| F[Response: No Schema]
    E -->|Yes| G[Build Agent Prompt]
    
    G --> H[Call Gemini AI Agent]
    H --> I{Agent Decision}
    
    I -->|Need Data| J[Function Call: execute_sql]
    I -->|Can Answer| K[Generate Response]
    
    J --> L[Execute SQL Query]
    L --> M{Success?}
    M -->|No| N[Retry with Fixed SQL]
    M -->|Yes| O[Return Results to Agent]
    
    N --> M
    O --> H
    
    K --> P[Extract Chart Data]
    P --> Q[Format Final Answer]
    Q --> R[Return to User]
    
    style A fill:#e1f5ff
    style R fill:#c8e6c9
    style J fill:#fff9c4
    style L fill:#ffccbc
```

### 4. **Conversation Context Management**

```typescript
interface ConversationContext {
  question: string;
  answer: string;
  sql?: string;
  timestamp: number;
}
```

**Features:**
- LÆ°u trá»¯ lá»‹ch sá»­ há»™i thoáº¡i
- Context-aware responses
- Multi-turn conversations
- Follow-up questions

### 5. **Chart Data Generation**

AI Agent tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  generate chart data phÃ¹ há»£p:

```typescript
interface ChartData {
  type: "bar" | "pie" | "line" | "none";
  data: Array<{ name: string; value: number }>;
  xAxisKey?: string;
  yAxisKey?: string;
  description?: string;
}
```

**Chart Type Rules:**
- **Bar**: So sÃ¡nh categories (2-20 items) - Sales by region, orders by status
- **Pie**: Tá»· lá»‡ pháº§n trÄƒm (3-8 slices) - Market share, status distribution  
- **Line**: Xu hÆ°á»›ng theo thá»i gian (5+ points) - Monthly sales, user growth
- **None**: Dá»¯ liá»‡u khÃ´ng phÃ¹ há»£p cho visualization

## Database Support

### Supported Databases
- âœ… **Microsoft SQL Server** (MSSQL)
- âœ… **PostgreSQL**
- âœ… **MySQL**

### Schema Extraction Queries
ğŸ“ `server/db/get-schema/`
- `mssql.sql` - INFORMATION_SCHEMA queries for SQL Server
- `postgres.sql` - PostgreSQL system catalog queries
- `mysql.sql` - MySQL INFORMATION_SCHEMA queries

## Technology Stack

### Frontend
- **React 18** - UI framework
- **TypeScript** - Type safety
- **Redux Toolkit** - State management
- **Vite** - Build tool
- **Recharts** - Data visualization

### Backend
- **Node.js + Express** - API server
- **TypeScript** - Type safety
- **PostgreSQL + pgvector** - Vector database for embeddings
- **Google Gemini AI** - LLM for query generation

### VS Code Extension
ğŸ“ `vs-extension/`
- TÃ­ch há»£p DataLens AI trá»±c tiáº¿p vÃ o VS Code
- Chat panel vá»›i database connection
- Quick access tá»« editor

## Security & Best Practices

### SQL Injection Prevention
- âœ… Agent chá»‰ generate SELECT statements
- âœ… KhÃ´ng cho phÃ©p INSERT, UPDATE, DELETE, DROP
- âœ… Schema prefix báº¯t buá»™c
- âœ… LIMIT/TOP clause máº·c Ä‘á»‹nh

### Error Handling
- **Retry Logic**: Tá»± Ä‘á»™ng retry vá»›i fixed SQL (max 2 attempts)
- **Fallback Answers**: Tráº£ vá» káº¿t quáº£ há»£p lÃ½ khi agent fails
- **Common SQL Fixes**: Auto-fix missing schema prefix, syntax errors

### Performance Optimization
- **Batch Processing**: Xá»­ lÃ½ schema theo batch (50 tables)
- **Lazy Loading**: Chá»‰ load relevant tables
- **Query Limits**: Giá»›i háº¡n káº¿t quáº£ (10-100 rows)
- **Vector Search**: Fast semantic search vá»›i pgvector
- **Iterative Execution**: Max 5 iterations Ä‘á»ƒ trÃ¡nh infinite loops

## Data Flow Example

### VÃ­ dá»¥: "Show me top 5 products by sales"

```
1. User Input
   â†“
2. RAG Search â†’ Find tables: [Products, Sales, OrderItems]
   â†“
3. AI Agent receives:
   - Question: "Show me top 5 products by sales"
   - Schema: Products, Sales, OrderItems definitions
   - Conversation history (if any)
   â†“
4. Agent Decision â†’ "Need to query database"
   â†“
5. Function Call: execute_sql
   sql: "SELECT TOP 5 p.ProductName, SUM(oi.Quantity * oi.Price) as TotalSales 
         FROM dbo.Products p 
         JOIN dbo.OrderItems oi ON p.ProductID = oi.ProductID 
         GROUP BY p.ProductName 
         ORDER BY TotalSales DESC"
   â†“
6. Execute SQL â†’ Returns results
   â†“
7. Agent analyzes results â†’ Generate insights
   â†“
8. Extract chart data â†’ type: "bar"
   â†“
9. Format markdown answer with table + insights
   â†“
10. Return to user with chart visualization
```

## Future Improvements

### Planned Features
- [ ] Support for more databases (Oracle, MongoDB)
- [ ] Multi-database queries (JOIN across databases)
- [ ] Query optimization suggestions
- [ ] Natural language to SQL training mode
- [ ] Export results to CSV/Excel
- [ ] Scheduled queries & alerts
- [ ] Dashboard builder with saved queries

### AI Enhancements
- [ ] Fine-tuning for domain-specific queries
- [ ] Custom schema annotations
- [ ] Query performance prediction
- [ ] Automatic index suggestions
- [ ] Data quality insights

## Development Setup

### Prerequisites
```bash
Node.js >= 18
PostgreSQL >= 14 (with pgvector extension)
pnpm >= 8
```

### Installation
```bash
# Clone repository
git clone <repo-url>

# Install dependencies
pnpm install

# Setup environment
cp .env.example .env
# Add VITE_GEMINI_API_KEY

# Start PostgreSQL with pgvector
docker-compose up -d

# Run migrations
cd server && pnpm run migrate

# Start dev server
pnpm dev
```

### Project Structure
```
datalens-ai/
â”œâ”€â”€ src/                      # Frontend React app
â”‚   â”œâ”€â”€ components/          # UI components
â”‚   â”œâ”€â”€ services/            # API & AI services
â”‚   â”‚   â””â”€â”€ aiService2.ts   # ğŸŒŸ Smart AI Agent (Core)
â”‚   â”œâ”€â”€ store/              # Redux state management
â”‚   â””â”€â”€ pages/              # Application pages
â”œâ”€â”€ server/                  # Backend API server
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ services/       # Business logic
â”‚   â”‚   â”œâ”€â”€ repositories/   # Data access layer
â”‚   â”‚   â””â”€â”€ db/            # Database utilities
â”‚   â””â”€â”€ db/
â”‚       â”œâ”€â”€ migrations/     # SQL migrations
â”‚       â””â”€â”€ get-schema/     # Schema extraction queries
â”œâ”€â”€ vs-extension/           # VS Code extension
â””â”€â”€ docker-compose.yml      # PostgreSQL + pgvector setup
```

## API Endpoints

### Database Management
- `POST /api/databases` - Add new database connection
- `GET /api/databases` - List all databases
- `GET /api/databases/:id/schema` - Get database schema
- `POST /api/databases/:id/index-schema` - Generate embeddings

### Query Execution
- `POST /api/query/execute` - Execute SQL query
- `POST /api/query/ai` - AI-powered natural language query

### Schema Search
- `POST /api/schema/search` - Semantic search for relevant tables

## Contributing

### Code Style
- TypeScript strict mode
- ESLint + Prettier
- Conventional commits

### Testing
```bash
# Run tests
pnpm test

# Run with coverage
pnpm test:coverage
```

## License

MIT License - See LICENSE file for details

---

**Built with â¤ï¸ using Google Gemini AI & PostgreSQL**
